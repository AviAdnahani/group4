<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>FE 39</title>
    <script>sum = 0;</script>
</head>

<body>
    <table id="table">
        <tr>
            <th>Name</th>
            <th>Price</th>
            <th>Action</th>
        </tr>

        <tr>
            <td>
                <select id="name">
                    <option>Volvo</option>
                    <option>Mercedes</option>
                    <option>BMW</option>
                    <option>Mazda</option>
                </select>
            </td>
            <td>
                <input id="price" type="number">
            </td>
            <td>
                <button id="action" onclick="addRow()">Add</button>
            </td>

    </table>

    Sum:
    <div id="sum"></div>

    <form id="paymentInfo" action="http://localhost:3000/Order" method="POST" onsubmit="return false">
        Card Number:<input id="cardNumber" type="text" required><br><br>
        Name on card:<input id="nameOnCard" type="text" required><br><br>
        Expiration date:<input id="expirationDate" type="date" required><br><br>
        Security Code<input id="securityCode" type="number" minlength="3" maxlength="3" required><br><br>
        <input type="button" value="Submit" onclick="validate()">
    </form>

    <div id="errorDiv"></div>

    <script>
        var sum = 0;

        function addRow() {
            var price = document.getElementById("price").value;
            var intPrice= parseInt(price, 10);
            sum+=intPrice;
            var sumDiv = document.getElementById("sum");
            sumDiv.innerText=sum;
            var table = document.getElementById("table");
            var newRow = document.createElement("tr");
            var newName = document.createElement("td");
            newName.innerText= document.getElementById("name").value;
            var newPrice = document.createElement("td");
            newPrice.innerText = document.getElementById("price").value;
            var newAction = document.createElement("td");
            var newButton = document.createElement("button");
            newButton.innerText="Remove";
            newButton.onclick = function(){
                this.parentNode.remove();
                sum-=price;
                sumDiv.innerText=sum;
            }
            newRow.appendChild(newName);
            newRow.appendChild(newPrice);
            newRow.appendChild(newButton);
            table.appendChild(newRow);

            
        }

        function validate() {
            var cardNumber = document.getElementById("cardNumber").value;
            var error = document.getElementById("errorDiv");
            error.innerHTML = " ";
            var paymentInfo = document.getElementById("paymentInfo");
            var result = validateCreditCard(cardNumber);
            if (result.valid) {
                error.innerHTML = " ";
                paymentInfo.onsubmit = true;
            }
            else {
                error.innerHTML = result.error;
            }
        }

        function validateCreditCard(creditCard) {
            var creditCardNumbers;
            var creditCardNumbersSum = 0;
            var creditCardWithNoDashes;
            var div = document.createElement('div');

            creditCardWithNoDashes = creditCard.split("-");
            creditCardWithNoDashes = creditCardWithNoDashes.join("");
            creditCardNumbers = creditCardWithNoDashes.split("").map(Number);

            function checkLength(creditCardWithNoDashes) {
                return (creditCardWithNoDashes.length == 16);
            }

            function checkAllItemsNumbers(creditCardNumbers) {
                var isAllItemsNumbers = creditCardNumbers.every(function (element) {
                    creditCardNumbersSum += element;
                    return (element >= 0 && element <= 9);
                });

                return isAllItemsNumbers;
            }

            function checkDigitsSum() {
                return (creditCardNumbersSum > 16);
            }

            function checkIfAllDigitsSame(creditCardNumbers) {
                var isAllDigitsSame = creditCardNumbers.every(function (element) {
                    return element === creditCardNumbers[0];
                });
                return !isAllDigitsSame;
            }

            function CheckLastDigitEven(creditCardNumbers) {
                return (creditCardNumbers[creditCardNumbers.length - 1] % 2 == 0)
            }

            if (checkLength(creditCardNumbers)) {
                if (checkAllItemsNumbers(creditCardNumbers)) {
                    if (checkDigitsSum()) {
                        if (checkIfAllDigitsSame(creditCardNumbers)) {
                            if (CheckLastDigitEven(creditCardNumbers)) {
                                return { valid: true, number: creditCard }
                            }
                            else {
                                return { valid: false, error: "odd final number", number: creditCard }
                            }
                        }
                        else {
                            return { valid: false, error: "only one type of number", number: creditCard }
                        }
                    }
                    else {
                        return { valid: false, error: "sum less than 16", number: creditCard }
                    }
                }
                else {
                    return { valid: false, error: "invalid characters", number: creditCard }
                }
            }
            else {
                return { valid: false, error: "Credit Card Length Must Be 16 Digits", number: creditCard }
            }
        }

    </script>
</body>

</html>